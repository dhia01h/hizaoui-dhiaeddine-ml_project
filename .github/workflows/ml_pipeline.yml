name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: âš™ï¸ Configurer Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ğŸ“¦ Installer les dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ§ª ExÃ©cuter les tests unitaires
      run: PYTHONPATH=src pytest tests/

  train:
    needs: test
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: âš™ï¸ Configurer Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ğŸ“¦ Installer les dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸš€ EntraÃ®nement du modÃ¨le
      run: python src/main.py --train

  evaluate:
    needs: train
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout du code
      uses: actions/checkout@v4

    - name: âš™ï¸ Configurer Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: ğŸ“¦ Installer les dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸ“Š Ã‰valuation du modÃ¨le
      run: python src/main.py --evaluate

  notify:
    needs: evaluate
    runs-on: ubuntu-latest
    if: success()

    steps:
    - name: ğŸ“© Envoyer une notification par email
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "âœ… CI/CD Pipeline terminÃ© avec succÃ¨s !"
        body: |
          Bonjour Dhia ğŸ‘‹,

          ğŸ‰ Le pipeline CI/CD de ton projet **hizaoui-dhiaeddine-ml_project** a Ã©tÃ© exÃ©cutÃ© avec succÃ¨s.

          ğŸ“Œ Voir les rÃ©sultats ici : [GitHub Actions](https://github.com/dhia01h/hizaoui-dhiaeddine-ml_project/actions)

          Cordialement,
          ğŸš€ CI/CD Bot
        to: "dhia.hizaoui@esprit.tn"
        from: "CI/CD Bot <ci-bot@hizaoui-dhiaeddine-ml_project.com>"
